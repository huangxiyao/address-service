---
  - name: validate LB apache health page
    uri: url=https://{{ item }}/{{ health_check_url }} status_code=200
    retries: 5
    delegate_to: localhost
    with_items: lb_urls

  - name: validate LB data-match health page
    uri: url=https://{{ item }}/match/about/health status_code=204
    retries: 5
    delegate_to: localhost
    with_items: lb_urls

  - name: validate LB data-match restful endpoint
    uri: url=https://{{ item[0]  }}/match/{{ item[1] }}/documentation status_code=200
    retries: 5
    delegate_to: localhost
    with_nested:
      - lb_urls
      - [ validatedAddress, certifiedAddress, looselyValidatedAddress, addressSuggestions, fastCompletionAddress ]

  - name: validate LB data-match soap endpoint
    uri: url=https://{{ item }}/legacy-match/address/v1?wsdl status_code=200
    retries: 5
    delegate_to: localhost
    with_items: lb_urls

  - name: validate LB data-match restful addresses
    uri: url=https://{{ item[0] }}/match/{{ item[1] }}?country1=US&deliveryAddressLine1=745+Riverhaven+Drive&characterScriptDetectionIndicator=false&postalCode1=30024 HEADER_X-HP-Application-Process-UID="w-mdcp:prd-http"
    retries: 5
    delegate_to: localhost
    with_nested:
      - lb_urls
      - [ validatedAddress, certifiedAddress, looselyValidatedAddress, addressSuggestions, fastCompletionAddress ]

  - name: download soap test file and function template file -> /tmp
    template: src={{ item.src }} dest=/tmp mode={{ item.mode }} force
    with_items:
      - { src: 'soap_envelope.xml', mode: '0644' }
      - { src: 'acceptance-test-functions.sh', mode: '0755' }

  - name: validate LB data-match soap addresses
    action: command bash /tmp/acceptance-test-functions.sh soapValidationTest {{ item }}
    with_items: lb_urls

  - name: final cleanup
    action: command bash /tmp/acceptance-test-functions.sh finalCleanup