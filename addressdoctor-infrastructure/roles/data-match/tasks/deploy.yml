---
  - name: Download the argument's template files -> /opt/casfw
    template: src=data-match-functions.sh dest={{ casfw_home }} mode=0755 owner={{ useraccount }} group={{ usergroup }} force

  - name: search if there is the data-match instance process
    shell: cd {{ casfw_home }}/current/{{ data_match_instance }}
    register: checkProcess_result
    ignore_errors: True

  - name: stop current tomcat process
    action: command bash {{ casfw_home }}/data-match-functions.sh stopTomcatPS
    when: checkProcess_result.rc == 0

  - name: clean up data-match instances
    action: command bash {{ casfw_home }}/data-match-functions.sh cleanupInstance

  - name: clean up the current
    action: command bash {{ casfw_home }}/data-match-functions.sh cleanupCurrent

  - name: Download the argument's template files -> {{ casfw_home }}
    template: src={{ item }} dest={{ casfw_home }} mode=0664 owner={{ useraccount }} group={{ usergroup }} force
    with_items:
      - "data-match-cdi-args.txt"
      - "soap_envelope.xml"

  - name: Check tomcat process stopped
    action: command bash {{ casfw_home }}/data-match-functions.sh checkTomcatProcessStopped
    register: checkTomcatProcessStoppedResponse

  - name: install new cdi
    action: command bash {{ casfw_home }}/data-match-functions.sh installcdi
    when: checkTomcatProcessStoppedResponse.stdout == 'Tomcat Process Stopped'

  - name: Check tomcat process started
    action: command bash {{ casfw_home }}/data-match-functions.sh checkTomcatProcessStarted
    register: checkTomcatProcessStartedResponse

  - name: check if the tomcat start with database loading
    action: command bash {{ casfw_home }}/data-match-functions.sh checkTomcatInstanceStartFinished
    when: checkTomcatProcessStartedResponse.stdout == 'Tomcat Process Started'
    register: check_result

  - name: validate Restful Endpoint
    action: command bash {{ casfw_home }}/data-match-functions.sh restfulEndpointTest
    when: check_result.stdout == '</GetConfig>\nStart Finished' 

  - name: validate Soap Endpoint
    action: command bash {{ casfw_home }}/data-match-functions.sh soapEndpointTest

  - name: Sample validate Restful Endpoint Test
    action: command bash {{ casfw_home }}/data-match-functions.sh restValidationTest

  - name: Sample Validate Soap Endpoint Test
    action: command bash {{ casfw_home }}/data-match-functions.sh soapValidationTest

  - name: Check databases loaded
    action: command bash {{ casfw_home }}/data-match-functions.sh checkDatabasesLoaded

  - name: Final cleanup
    action: command bash {{ casfw_home }}/data-match-functions.sh finalCleanup

