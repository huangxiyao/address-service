---
# This playbook is for Address Doctor tomcat instance restart
  - name: Download the argument's template files -> /opt/casfw
    template: src=db-restart-tomcat-functions.sh dest={{ casfw_home }} mode=0755 owner={{ useraccount }} group={{ usergroup }} force

  - name: Download the argument's template files -> /opt/casfw
    template: src=soap_envelope.xml dest={{ casfw_home }} mode=0664 owner={{ useraccount }} group={{ usergroup }}  force

  - name: Stop tomcat instance
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh stopTomcatInstance

  - name: Wait for data-match port to stopped
    wait_for: host={{ inventory_hostname }} port={{ port }} delay=15 state=stopped
    su: no
    delegate_to: localhost

  - name: Start tomcat instance
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh startTomcatInstance

  - name: Wait for data-match port to started
    wait_for: host={{ inventory_hostname }} port={{ port }} delay=15 state=started
    su: no
    delegate_to: localhost

  - name: Wait for data-match databases load are finished and data-match instance start finished
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh waitDatabasesLoadFinished
    register: waitDatabasesLoadFinishedResponse

  - name: Check databases loaded
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh checkDatabasesLoaded
    when: waitDatabasesLoadFinishedResponse.stdout == 'Databases Load Finished'

  - name: Validate Restful Endpoint
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh restfulEndpointTest 

  - name: Validate Soap Endpoint
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh soapEndpointTest

  - name: Sample validate Restful Endpoint Test
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh restValidationTest

  - name: Sample Validate Soap Endpoint Test
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh soapValidationTest

  - name: Final Cleanup
    action: command bash {{ casfw_home }}/db-restart-tomcat-functions.sh finalCleanup